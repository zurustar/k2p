# Kindle to PDF Converter (k2p)

macOS上でKindleの本をPDF形式に変換するGoベースのコマンドラインツールです。ページめくりとスクリーンショット撮影を自動化し、高品質なPDFを生成します。

## 主な機能

- 📚 **自動変換**: Kindleの本を全自動でPDF化
- ✂️ **スマートトリミング**: 黒/白の縁を自動検出・削除
- 📏 **カスタムマージン**: 上下左右のトリミング幅をピクセル指定
- 🔄 **自動検出**: ページめくり方向と本の終わりを自動判定
- ⚙️ **柔軟な設定**: 画質、タイミング、出力先を自由にカスタマイズ
- 🛡 **安全設計**: ディスク容量チェック、誤操作防止機能

## クイックスタート

### 1. インストール

```bash
git clone https://github.com/oumi/k2p.git
cd k2p
make build
# 権限設定が必要です（詳細は下記「セットアップ」参照）
```

### 2. 実行

Kindleアプリで本を開き、コマンドを実行します：

```bash
# 標準変換
./build/k2p

# 縁なし（トリミングあり）で変換
./build/k2p --trim-borders

# 詳細モード（デバッグ情報あり）
./build/k2p --verbose
```

## セットアップ（初回のみ）

k2pを使用するには、macOSのセキュリティ設定で以下の権限を付与する必要があります。

1. **アクセシビリティ権限**: 
   - システム環境設定 > プライバシーとセキュリティ > アクセシビリティ
   - `build/k2p` バイナリを追加して許可

2. **画面収録権限**:
   - システム環境設定 > プライバシーとセキュリティ > 画面収録
   - ターミナルアプリ（iTerm2など）を許可

詳細は[権限設定ガイド](#権限設定ガイド)を参照してください。

## 使い方詳細

### 基本コマンド

```bash
# 出力先を指定
k2p -o ~/Documents/MyBook

# 画質優先設定（PDF画質: high, スクリーンショット品質: 100）
k2p --quality 100 --pdf-quality high
```

### トリミング機能

k2pは強力なトリミング機能を備えています。

#### 自動トリミング
黒帯や白枠を自動的に検出して削除します。
```bash
k2p --trim-borders
```

#### カスタムマージン
ページ全体から指定ピクセル数だけ削除します（ヘッダー/フッター削除に便利）。
```bash
# 上部100px、下部50pxを削除
k2p --trim-top 100 --trim-bottom 50 --mode generate
```

#### マージン検出モード
PDFを作成せずに、最適なトリミング幅を計算して表示します。
```bash
k2p --mode detect
```

### 詳細オプション

| フラグ | 説明 | デフォルト |
|--------|------|------------|
| `--output`, `-o` | 出力ディレクトリ | カレント |
| `--trim-borders` | 自動ボーダートリミング | false |
| `--trim-top` | 上部トリミング (px) | 0 |
| `--trim-bottom` | 下部トリミング (px) | 0 |
| `--page-turn-key` | めくり方向 (left/right) | 自動検出 |
| `--auto-confirm`, `-y` | 開始確認をスキップ | false |
| `--verbose`, `-v` | 詳細ログ表示 | false |

---

## 権限設定ガイド

詳細なセットアップ手順です。

### 1. アクセシビリティ（ページめくり用）
1. システム環境設定 → セキュリティとプライバシー → アクセシビリティ
2. 鍵アイコンを解除
3. `+` ボタンをクリックして `build/k2p` を追加

> **注意**: 再ビルドするたびに、この権限を削除・再追加する必要がある場合があります。

### 2. 画面収録（スクリーンショット用）
1. システム環境設定 → セキュリティとプライバシー → 画面収録
2. ターミナルアプリ（Terminal, iTerm2, VSCodeなど）にチェックを入れる
3. アプリを再起動

## トラブルシューティング

### 「ページがめくれない」/ 「同じページが繰り返しキャプチャされる」

**原因**: k2pにアクセシビリティ権限がありません。

**解決方法**:
1. 上記の[初期セットアップ](#初期セットアップ必須)手順に従う
2. ターミナルではなく、`build/k2p`バイナリに権限を付与したことを確認
3. 権限付与後、k2pを再起動

### 「Kindleアプリがインストールされていません」

**原因**: Kindleアプリがインストールされていないか、実行されていません。

**解決方法**:
- Mac App StoreからKindleをインストール
- k2pを実行する前にKindleアプリを起動

### 「本が開かれていません」

**原因**: Kindleアプリで本が開かれていません。

**解決方法**:
- Kindleで本を開く
- 変換したい最初のページに移動
- 本が表示されていることを確認（ライブラリビューではない）

### 「Kindleアプリが前面にありません」

**原因**: 起動遅延中にKindleウィンドウが前面にありません。

**解決方法**:
- k2pがカウントダウンを表示したら、Kindleウィンドウをクリックして前面に
- 変換中はKindleを前面に保つ
- 変換中に他のアプリに切り替えたり、最小化しない

### 「Kindle is not in foreground」エラーで変換が中断される

**原因**: 変換中にKindleアプリからフォーカスが外れました。

**解決方法**:
- 変換中はKindleアプリを前面に保ってください
- 他のアプリケーションをクリックしないでください
- 変換を停止したい場合は、Ctrl+Cを使用してプログラムを終了してください

> **安全機能**: Kindleがフォーカスを失った場合、他のアプリケーションへの誤操作を防ぐため、プログラムは自動的に終了します。


### 「ディスク容量が不足しています」

**原因**: 一時スクリーンショット用の空きディスク容量が不足しています。

**解決方法**:
- ディスク容量を確保（1ページあたり約1-2 MB必要）
- `--output`を使用して、より多くの空き容量があるディレクトリを指定

### スクリーンショットが空白または間違った内容

**原因**: Kindleが全画面表示でないか、前面にありません。

**解決方法**:
- Kindleを全画面表示モードにする（表示 → フルスクリーンにする）
- 変換中、Kindleが最前面のウィンドウであることを確認
- 変換中に他のアプリに切り替えない

## AI Agentによる開発

このプロジェクトでAI Agentを使って開発作業を行う場合、以下のルールに従ってください：

### 作業開始前の必須コマンド

**すべての実装作業やバグ修正を開始する前に、必ず以下のコマンドを実行してください：**

```
/start-work
```

このコマンドは、`.agent/workflows/start-work.md`に記載されている開発ガイドラインを読み込みます。

### なぜこれが重要か

- ドキュメント（`docs/tasks.md`と`docs/design.md`）を**コード実装の前に**更新することが必須です
- このワークフローに従わないと、設計ドキュメントとタスク管理が意味をなさなくなります
- 将来の開発者（人間とAI両方）が混乱します

### Order of Operations

1. ✓ `docs/tasks.md`を更新（タスク項目を追加）
2. ✓ `docs/design.md`を更新（必要に応じて）
3. ✓ コードを実装
4. ✓ `docs/tasks.md`でタスクを`[x]`としてマーク
5. ✓ `make build`とテストを実行

**小さなバグ修正であっても、ドキュメント更新をスキップしないでください。**

## 開発

### ビルド

```bash
make build
```

### テスト

```bash
make test
```

### テストの実行

```bash
# ユニットテスト
make test-unit

# 統合テスト
make test-integration
```

## プロジェクト構造

```
k2p/
├── cmd/k2p/           # メインアプリケーションエントリポイント
├── internal/          # プライベートパッケージ
│   ├── automation/    # Kindleアプリ自動化
│   ├── config/       # 設定管理
│   ├── filemanager/  # ファイル操作
│   ├── imageprocessing/ # 画像処理（トリミング、比較）
│   ├── orchestrator/ # 変換オーケストレーション
│   ├── pdf/          # PDF生成
│   └── screenshot/   # スクリーンショット撮影
├── docs/             # ドキュメント
└── Makefile          # ビルド自動化
```

## ライセンス

GNU General Public License v3.0 (GPL-3.0) - 詳細はLICENSEファイルを参照してください

このプログラムはフリーソフトウェアです。あなたはこれを、フリーソフトウェア財団によって発行された GNU 一般公衆利用許諾書(バージョン3か、それ以降のバージョンのうちどれか)が定める条件の下で再頒布または改変することができます。

