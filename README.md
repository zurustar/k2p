# k2p

macOS上であるアプリに対して左右どちらかの矢印キーの入力の送信とスクリーンショットの取得を交互に実行しまくって、収集したスクリーンショットPDFに変換するコマンドラインツールです。

## 主な機能

- 📚 **自動変換**: 取得したスクリーンショットのPDF化
- ✂️ **スマートトリミング**: 黒/白の縁の大きさの検出
- 📏 **カスタムマージン**: ピクセル指定された分だけ上下左右をトリミング

## クイックスタート

### 1. 実行

1. `k2p-gui` アプリケーションを起動します。
2. ブラウザが自動的に開き、GUIが表示されます。


## セットアップ（初回のみ）

k2pを使用するには、macOSのセキュリティ設定で以下の権限を付与する必要があります。

1. **アクセシビリティ権限**: 
   - システム環境設定 > プライバシーとセキュリティ > アクセシビリティ
   - `k2p-gui` アプリケーションを追加して許可

2. **画面収録権限**:
   - システム環境設定 > プライバシーとセキュリティ > 画面収録
   - ターミナルアプリ（iTerm2など）を許可

詳細は[権限設定ガイド](#権限設定ガイド)を参照してください。

## 使い方詳細

### 基本操作

GUI画面で以下の設定を行えます：

- **出力先**: PDFの保存先を指定
- **画質**: スクリーンショットの品質設定
- **遅延**: ページめくりなどの待機時間
- **モード**: 通常変換とマージン検出
- **トリミング**: 上下左右のトリミング設定


---

## 権限設定ガイド

詳細なセットアップ手順です。

### 1. アクセシビリティ（ページめくり用）
1. システム環境設定 → セキュリティとプライバシー → アクセシビリティ
2. 鍵アイコンを解除
3. `+` ボタンをクリックして `k2p-gui` を追加

> **注意**: 再ビルドするたびに、この権限を削除・再追加する必要がある場合があります。

### 2. 画面収録（スクリーンショット用）
1. システム環境設定 → セキュリティとプライバシー → 画面収録
2. ターミナルアプリ（Terminal, iTerm2, VSCodeなど）にチェックを入れる
3. アプリを再起動

## トラブルシューティング

### 「ページがめくれない」/ 「同じページが繰り返しキャプチャされる」

**原因**: k2pにアクセシビリティ権限がありません。

**解決方法**:
1. 上記の[初期セットアップ](#初期セットアップ必須)手順に従う
2. `k2p-gui` アプリケーションに権限を付与したことを確認
3. 権限付与後、k2pを再起動

### 「あるアプリがインストールされていません」

**原因**: あるアプリがインストールされていないか、実行されていません。

**解決方法**:
- Mac App Storeからインストール
- k2pを実行する前にそのアプリを起動

### 「本が開かれていません」

**原因**: あのアプリで本が開かれていません。

**解決方法**:
- あのアプリで本を開く
- 変換したい最初のページに移動
- 本が表示されていることを確認（ライブラリビューではない）

### 「あのアプリが前面にありません」

**原因**: 起動遅延中にあのウィンドウが前面にありません。

**解決方法**:
- k2pがカウントダウンを表示したら、あのウィンドウをクリックして前面に
- 変換中はあれを前面に保つ
- 変換中に他のアプリに切り替えたり、最小化しない

### 「なんちゃらforeground」エラーで変換が中断される

**原因**: 変換中にあのアプリからフォーカスが外れました。

**解決方法**:
- 変換中はあのアプリを前面に保ってください
- 他のアプリケーションをクリックしないでください
- 変換を停止したい場合は、Ctrl+Cを使用してプログラムを終了してください

> **安全機能**: あのアプリがフォーカスを失った場合、他のアプリケーションへの誤操作を防ぐため、プログラムは自動的に終了します。


### 「ディスク容量が不足しています」

**原因**: 一時スクリーンショット用の空きディスク容量が不足しています。

**解決方法**:
- ディスク容量を確保（1ページあたり約1-2 MB必要）
- `--output`を使用して、より多くの空き容量があるディレクトリを指定

### スクリーンショットが空白または間違った内容

**原因**: あのアプリが全画面表示でないか、前面にありません。

**解決方法**:
- あのアプリを全画面表示モードにする（表示 → フルスクリーンにする）
- 変換中、あのアプリが最前面のウィンドウであることを確認
- 変換中に他のアプリに切り替えない

## AI Agentによる開発

このプロジェクトでAI Agentを使って開発作業を行う場合、以下のルールに従ってください：

### 作業開始前の必須コマンド

**すべての実装作業やバグ修正を開始する前に、必ず以下のコマンドを実行してください：**

```
/start-work
```

このコマンドは、`.agent/workflows/start-work.md`に記載されている開発ガイドラインを読み込みます。

### なぜこれが重要か

- ドキュメント（`docs/tasks.md`と`docs/design.md`）を**コード実装の前に**更新することが必須です
- このワークフローに従わないと、設計ドキュメントとタスク管理が意味をなさなくなります
- 将来の開発者（人間とAI両方）が混乱します

### Order of Operations

1. ✓ `docs/tasks.md`を更新（タスク項目を追加）
2. ✓ `docs/design.md`を更新（必要に応じて）
3. ✓ コードを実装
4. ✓ `docs/tasks.md`でタスクを`[x]`としてマーク
5. ✓ `make build`とテストを実行

**小さなバグ修正であっても、ドキュメント更新をスキップしないでください。**

## 開発

### ビルド

```bash
make build
```

### テスト

```bash
make test
```

### テストの実行

```bash
# ユニットテスト
make test-unit

# 統合テスト
make test-integration
```

## プロジェクト構造

```
k2p/
├── cmd/k2p-gui/       # GUIアプリケーションエントリーポイント
├── internal/          # プライベートパッケージ
│   ├── automation/    # Kindleアプリ自動化
│   ├── config/       # 設定管理
│   ├── filemanager/  # ファイル操作
│   ├── imageprocessing/ # 画像処理（トリミング、比較）
│   ├── orchestrator/ # 変換オーケストレーション
│   ├── pdf/          # PDF生成
│   └── screenshot/   # スクリーンショット撮影
├── docs/             # ドキュメント
└── Makefile          # ビルド自動化
```

## ライセンス

GNU General Public License v3.0 (GPL-3.0) - 詳細はLICENSEファイルを参照してください

このプログラムはフリーソフトウェアです。あなたはこれを、フリーソフトウェア財団によって発行された GNU 一般公衆利用許諾書(バージョン3か、それ以降のバージョンのうちどれか)が定める条件の下で再頒布または改変することができます。

