# Kindle to PDF Converter (k2p)

macOS上でKindleの本をPDF形式に変換するGoベースのコマンドラインツールです。ページめくりとスクリーンショット撮影を自動化します。

## 機能

- 📚 現在開いているKindleの本をPDFに変換
- 🤖 自動ページめくりとスクリーンショット撮影
- ✂️ オプションのボーダートリミング（黒/白の縁を削除）
- 🔄 ページめくり方向の自動検出
- ⚙️ カスタマイズ可能な品質とタイミング設定
- 🎯 シンプルなコマンドラインインターフェース
- 🔧 設定ファイル対応

## 必要要件

- macOS 10.14以降
- Mac App StoreからインストールしたKindleアプリ
- Go 1.21以上（ソースからビルドする場合）

## 初期セットアップ（必須）

k2pを使用するには、2つのmacOS権限が必要です：

### 1. アクセシビリティ権限

k2pはKindleアプリのページめくりを自動化するために**アクセシビリティ権限**が必要です。

> **セキュリティに関する注意**: ターミナル全体ではなく、`k2p`バイナリのみに権限を付与することをお勧めします。これにより、権限の範囲をこのツールのみに限定できます。

#### セットアップ手順:

1. **k2pをビルド**（まだビルドしていない場合）:
   ```bash
   make build
   ```

2. **システム環境設定を開く**:
   - Appleメニュー → システム環境設定 → セキュリティとプライバシー
   - **プライバシー**タブを選択
   - 左サイドバーから**アクセシビリティ**を選択

3. **k2pに権限を付与**:
   - 左下の鍵アイコン（🔒）をクリックして変更を許可
   - **+**ボタンをクリック
   - k2pディレクトリに移動
   - `build/k2p`（バイナリファイル）を選択
   - **開く**をクリック
   - `k2p`の横のチェックボックスがオンになっていることを確認

4. **確認**:
   ```bash
   ./build/k2p --help
   ```

> **重要**: k2pバイナリを移動または再ビルドした場合、アクセシビリティ設定で古いエントリを削除して新しいものを追加する必要がある場合があります。

### 2. 画面収録権限

k2pはKindleのページをスクリーンショットで撮影するために**画面収録権限**が必要です。

#### セットアップ手順:

1. **システム環境設定を開く**:
   - Appleメニュー → システム環境設定 → セキュリティとプライバシー
   - **プライバシー**タブを選択
   - 左サイドバーから**画面収録**を選択

2. **ターミナルに権限を付与**:
   - 左下の鍵アイコン（🔒）をクリックして変更を許可
   - リストから**ターミナル**（またはk2pを実行しているアプリ）を探す
   - チェックボックスがオンになっていることを確認
   - リストにない場合は、**+**ボタンをクリックしてターミナルを追加

3. **ターミナルを再起動**:
   - 権限を有効にするため、ターミナルを完全に終了して再起動

> **注意**: この権限はk2pバイナリではなく、k2pを実行している**ターミナルアプリ**に付与する必要があります。

### 権限の削除（オプション）

使用後に権限を取り消したい場合:
1. システム環境設定 → セキュリティとプライバシー → プライバシーを開く
2. **アクセシビリティ**から`k2p`を削除
3. **画面収録**からターミナルのチェックを外す

## インストール

### ソースから

```bash
git clone https://github.com/oumi/k2p.git
cd k2p
make build
sudo make install
```

## 使い方

### 基本的な使い方

1. Kindleアプリで本を開く
2. 本を**全画面表示**にする（表示 → フルスクリーンにする）
3. 変換ツールを実行:

```bash
k2p
```

PDFは現在のディレクトリに保存されます。

### 高度な使い方

```bash
# 出力ディレクトリを指定
k2p --output ~/Documents/MyBooks

# 高品質変換
k2p --quality 100 --pdf-quality high

# カスタムページめくり遅延
k2p --page-delay 1s

# 設定ファイルを使用
k2p --config config.yaml

# 詳細出力
k2p --verbose

# ボーダートリミングを有効化
k2p --trim-borders

# ページめくり方向を手動指定（通常は自動検出）
k2p --page-turn-key left
```

### 設定ファイル

`config.yaml`ファイルを作成:

```yaml
output_dir: ~/Documents/Kindle-PDFs
screenshot_quality: 95
page_delay: 500ms
startup_delay: 3s
show_countdown: true
pdf_quality: high
trim_borders: false  # trueに設定すると有効化
page_turn_key: right  # または "left"（通常は自動検出）
verbose: false
auto_confirm: false
```

## 動作の仕組み

1. **準備**: Kindleアプリで本を手動で開く
2. **自動化**: ツールが自動的に:
   - Kindleアプリの準備状態を確認
   - 各ページのスクリーンショットを撮影
   - 次のページに移動
   - 本の最後まで繰り返し
3. **PDF生成**: すべてのスクリーンショットを1つのPDFファイルに結合

## コマンドラインオプション

| オプション | 説明 | デフォルト |
|--------|-------------|---------|
| `-o, --output DIR` | 出力ディレクトリ | カレントディレクトリ |
| `--quality NUM` | スクリーンショット品質 (1-100) | 95 |
| `--page-delay DURATION` | ページめくり間の遅延 | 500ms |
| `--startup-delay DURATION` | 開始前の遅延 | 3s |
| `--pdf-quality LEVEL` | PDF品質 (low/medium/high) | high |
| `--trim-borders` | ボーダートリミングを有効化 | false |
| `--page-turn-key DIRECTION` | ページめくり方向 (right/left) | 自動検出 |
| `--config FILE` | 設定ファイルパス | - |
| `-v, --verbose` | 詳細ログを有効化 | false |
| `-y, --auto-confirm` | 確認プロンプトをスキップ | false |
| `--version` | バージョン情報を表示 | - |
| `-h, --help` | ヘルプメッセージを表示 | - |

## トラブルシューティング

### 「ページがめくれない」/ 「同じページが繰り返しキャプチャされる」

**原因**: k2pにアクセシビリティ権限がありません。

**解決方法**:
1. 上記の[初期セットアップ](#初期セットアップ必須)手順に従う
2. ターミナルではなく、`build/k2p`バイナリに権限を付与したことを確認
3. 権限付与後、k2pを再起動

### 「Kindleアプリがインストールされていません」

**原因**: Kindleアプリがインストールされていないか、実行されていません。

**解決方法**:
- Mac App StoreからKindleをインストール
- k2pを実行する前にKindleアプリを起動

### 「本が開かれていません」

**原因**: Kindleアプリで本が開かれていません。

**解決方法**:
- Kindleで本を開く
- 変換したい最初のページに移動
- 本が表示されていることを確認（ライブラリビューではない）

### 「Kindleアプリが前面にありません」

**原因**: 起動遅延中にKindleウィンドウが前面にありません。

**解決方法**:
- k2pがカウントダウンを表示したら、Kindleウィンドウをクリックして前面に
- 変換中はKindleを前面に保つ
- 変換中に他のアプリに切り替えたり、最小化しない

### 「Kindle is not in foreground」エラーで変換が中断される

**原因**: 変換中にKindleアプリからフォーカスが外れました。

**解決方法**:
- 変換中はKindleアプリを前面に保ってください
- 他のアプリケーションをクリックしないでください
- 変換を停止したい場合は、Ctrl+Cを使用してプログラムを終了してください

> **安全機能**: Kindleがフォーカスを失った場合、他のアプリケーションへの誤操作を防ぐため、プログラムは自動的に終了します。


### 「ディスク容量が不足しています」

**原因**: 一時スクリーンショット用の空きディスク容量が不足しています。

**解決方法**:
- ディスク容量を確保（1ページあたり約1-2 MB必要）
- `--output`を使用して、より多くの空き容量があるディレクトリを指定

### スクリーンショットが空白または間違った内容

**原因**: Kindleが全画面表示でないか、前面にありません。

**解決方法**:
- Kindleを全画面表示モードにする（表示 → フルスクリーンにする）
- 変換中、Kindleが最前面のウィンドウであることを確認
- 変換中に他のアプリに切り替えない

## 開発

### ビルド

```bash
make build
```

### テスト

```bash
make test
```

### テストの実行

```bash
# ユニットテスト
make test-unit

# 統合テスト
make test-integration
```

## プロジェクト構造

```
k2p/
├── cmd/k2p/           # メインアプリケーションエントリポイント
├── pkg/               # 公開パッケージ
│   ├── automation/    # Kindleアプリ自動化
│   ├── pdf/          # PDF生成
│   ├── config/       # 設定管理
│   ├── filemanager/  # ファイル操作
│   ├── imageprocessing/ # 画像処理（トリミング、比較）
│   └── screenshot/   # スクリーンショット撮影
├── internal/          # プライベートパッケージ
│   └── orchestrator/ # 変換オーケストレーション
├── docs/             # ドキュメント
└── Makefile          # ビルド自動化
```

## ライセンス

MIT License - 詳細はLICENSEファイルを参照してください

## コントリビューション

コントリビューションを歓迎します！プルリクエストをお気軽に送信してください。

## 謝辞

[kindle-to-pdf](https://github.com/rriifftt/kindle-to-pdf)のコンセプトに基づいています。
